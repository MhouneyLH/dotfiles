---
- name: Include custom keyboard tasks
  ansible.builtin.include_tasks: custom_keyboard.yml

- name: Install Node.js and npm
  ansible.builtin.apt:
    name:
      - nodejs
      - npm
    state: present
  tags: development_nodejs

- name: Install pnpm globally
  community.general.npm:
    name: pnpm
    version: latest-10
    global: true
  tags: development_nodejs

- name: Setup Docker
  block:
    - name: Add Docker GPG key
      ansible.builtin.get_url:
        url: https://download.docker.com/linux/debian/gpg
        dest: /tmp/docker.asc
        mode: "0644"

    - name: Add Docker GPG key to keyring
      ansible.builtin.shell:
        cmd: gpg --dearmor < /tmp/docker.asc > /usr/share/keyrings/docker-archive-keyring.gpg
        creates: /usr/share/keyrings/docker-archive-keyring.gpg

    - name: Get system architecture
      ansible.builtin.command: dpkg --print-architecture
      register: system_arch
      changed_when: false

    - name: Get distribution codename
      ansible.builtin.command: lsb_release -cs
      register: distro_codename
      changed_when: false

    - name: Add Docker repository
      ansible.builtin.apt_repository:
        repo: "deb [arch={{ system_arch.stdout }} signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/debian {{ distro_codename.stdout }} stable"
        filename: docker
        state: present

    - name: Install Docker packages
      ansible.builtin.apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present
        update_cache: true

    - name: Create docker group
      ansible.builtin.group:
        name: docker
        state: present

    - name: Add user to docker group
      ansible.builtin.user:
        name: "{{ user_name }}"
        groups: docker
        append: true

    - name: Enable and start Docker service
      ansible.builtin.systemd:
        name: docker
        enabled: true
        state: started
  tags: development_docker

- name: Install Kubernetes tools
  block:
    - name: Get latest kubectl version
      ansible.builtin.uri:
        url: https://dl.k8s.io/release/stable.txt
        return_content: true
      register: kubectl_version

    - name: Download kubectl binary
      ansible.builtin.get_url:
        url: "https://dl.k8s.io/release/{{ kubectl_version.content | trim }}/bin/linux/amd64/kubectl"
        dest: /tmp/kubectl
        mode: "0755"

    - name: Install kubectl
      ansible.builtin.copy:
        src: /tmp/kubectl
        dest: /usr/local/bin/kubectl
        mode: "0755"
        remote_src: true

    - name: Clean up kubectl installer
      ansible.builtin.file:
        path: /tmp/kubectl
        state: absent

    - name: Download k9s
      ansible.builtin.get_url:
        url: "https://github.com/derailed/k9s/releases/latest/download/k9s_linux_amd64.deb"
        dest: /tmp/k9s_linux_amd64.deb
        mode: "0644"

    - name: Install k9s
      ansible.builtin.apt:
        deb: /tmp/k9s_linux_amd64.deb
        state: present

    - name: Clean up k9s installer
      ansible.builtin.file:
        path: /tmp/k9s_linux_amd64.deb
        state: absent

    - name: Download minikube
      ansible.builtin.get_url:
        url: https://storage.googleapis.com/minikube/releases/latest/minikube_latest_amd64.deb
        dest: /tmp/minikube_latest_amd64.deb
        mode: "0644"

    - name: Install minikube
      ansible.builtin.apt:
        deb: /tmp/minikube_latest_amd64.deb
        state: present

    - name: Clean up minikube installer
      ansible.builtin.file:
        path: /tmp/minikube_latest_amd64.deb
        state: absent
  tags: development_kubernetes

- name: Install Terraform
  block:
    - name: Add HashiCorp GPG key
      ansible.builtin.get_url:
        url: https://apt.releases.hashicorp.com/gpg
        dest: /tmp/hashicorp.asc
        mode: "0644"

    - name: Add HashiCorp GPG key to keyring
      ansible.builtin.shell:
        cmd: gpg --dearmor < /tmp/hashicorp.asc > /usr/share/keyrings/hashicorp-archive-keyring.gpg
        creates: /usr/share/keyrings/hashicorp-archive-keyring.gpg

    - name: Get system architecture
      ansible.builtin.command: dpkg --print-architecture
      register: system_arch
      changed_when: false

    - name: Get distribution codename
      ansible.builtin.command: lsb_release -cs
      register: distro_codename
      changed_when: false

    - name: Add HashiCorp repository
      ansible.builtin.apt_repository:
        repo: "deb [arch={{ system_arch.stdout }} signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com {{ distro_codename.stdout }} main"
        filename: hashicorp
        state: present

    - name: Install Terraform
      ansible.builtin.apt:
        name: terraform
        state: present
        update_cache: true

    - name: Clean up HashiCorp GPG key file
      ansible.builtin.file:
        path: /tmp/hashicorp.asc
        state: absent
  tags: development_terraform

- name: Install uv Python package manager
  block:
    - name: Download uv installer
      ansible.builtin.get_url:
        url: https://astral.sh/uv/install.sh
        dest: /tmp/uv-install.sh
        mode: "0755"

    - name: Install uv
      ansible.builtin.shell:
        cmd: /tmp/uv-install.sh
      become_user: "{{ user_name }}"
      args:
        creates: "{{ user_home }}/.cargo/bin/uv"

    - name: Clean up uv installer
      ansible.builtin.file:
        path: /tmp/uv-install.sh
        state: absent
  tags: development_python

- name: Install lazygit
  ansible.builtin.apt:
    name: lazygit
    state: present
  tags: development_git

- name: Install JetBrains Toolbox
  tags: development_jetbrains
  block:
    - name: Download JetBrains Toolbox
      ansible.builtin.get_url:
        url: https://download.jetbrains.com/toolbox/jetbrains-toolbox-2.5.2.35332.tar.gz
        dest: /tmp/jetbrains-toolbox.tar.gz
        mode: "0644"

    - name: Create JetBrains Toolbox directory
      ansible.builtin.file:
        path: /opt/jetbrains-toolbox
        state: directory
        mode: "0755"

    - name: Extract JetBrains Toolbox
      ansible.builtin.unarchive:
        src: /tmp/jetbrains-toolbox.tar.gz
        dest: /opt/jetbrains-toolbox
        remote_src: true
        extra_opts:
          - --strip-components=1

    - name: Create symbolic link for JetBrains Toolbox
      ansible.builtin.file:
        src: /opt/jetbrains-toolbox/jetbrains-toolbox
        dest: /usr/local/bin/jetbrains-toolbox
        state: link

    - name: Create desktop entry for JetBrains Toolbox
      ansible.builtin.copy:
        dest: /usr/share/applications/jetbrains-toolbox.desktop
        content: |
          [Desktop Entry]
          Version=1.0
          Type=Application
          Name=JetBrains Toolbox
          Icon=jetbrains-toolbox
          Exec=/opt/jetbrains-toolbox/jetbrains-toolbox
          Comment=JetBrains Toolbox App
          Categories=Development;IDE;
          Terminal=false
          StartupWMClass=jetbrains-toolbox
        mode: "0644"

    - name: Clean up JetBrains Toolbox installer
      ansible.builtin.file:
        path: /tmp/jetbrains-toolbox.tar.gz
        state: absent

- name: Ensure .ssh directory exists
  ansible.builtin.file:
    path: "{{ user_home }}/.ssh"
    state: directory
    owner: "{{ user_name }}"
    group: "{{ user_name }}"
    mode: "0700"
  become_user: "{{ user_name }}"
  become: true
  tags: development_ssh

- name: Ensure .ssh/github directory exists
  ansible.builtin.file:
    path: "{{ user_home }}/.ssh/github"
    state: directory
    owner: "{{ user_name }}"
    group: "{{ user_name }}"
    mode: "0700"
  become_user: "{{ user_name }}"
  become: true
  tags: development_ssh

- name: Fix SSH private key permissions
  ansible.builtin.file:
    path: "{{ user_home }}/.ssh/{{ item }}"
    owner: "{{ user_name }}"
    group: "{{ user_name }}"
    mode: "0600"
  become_user: "{{ user_name }}"
  become: true
  loop:
    - github/id_ed25519
    - id_rsa
    - id_ed25519
  ignore_errors: true # Files might not exist
  tags: development_ssh

- name: Fix SSH public key permissions
  ansible.builtin.file:
    path: "{{ user_home }}/.ssh/{{ item }}"
    owner: "{{ user_name }}"
    group: "{{ user_name }}"
    mode: "0644"
  become_user: "{{ user_name }}"
  become: true
  loop:
    - github/id_ed25519.pub
    - id_rsa.pub
    - id_ed25519.pub
  ignore_errors: true # Files might not exist
  tags: development_ssh
